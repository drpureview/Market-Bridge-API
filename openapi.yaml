openapi: 3.1.0
info:
  title: Market Bridge API - OHLCV & Indicators Only
  version: 1.2.0

servers:
  - url: https://upstox-api.onrender.com

paths:
  /health:
    get:
      operationId: healthCheck
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  ts:
                    type: number

  /api/map:
    get:
      operationId: mapSymbol
      summary: Normalize symbol to Upstox instrument
      parameters:
        - in: query
          name: symbol
          required: true
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MapResponse"

  /api/historical:
    get:
      operationId: getHistoricalYfinance
      summary: Historical OHLCV from yfinance
      parameters:
        - in: query
          name: symbol
          required: true
          schema:
            type: string
        - in: query
          name: period
          required: false
          schema:
            type: string
            default: 6mo
        - in: query
          name: interval
          required: false
          schema:
            type: string
            default: 1d
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HistoricalResponse"
        "404":
          description: Not Found

  /api/historical_upstox:
    get:
      operationId: getHistoricalUpstox
      summary: Historical OHLCV from Upstox
      parameters:
        - in: query
          name: symbol
          required: false
          schema:
            type: string
        - in: query
          name: instrument_key
          required: false
          schema:
            type: string
        - in: query
          name: unit
          required: false
          schema:
            type: string
            enum: [days, weeks, months]
            default: days
        - in: query
          name: interval
          required: false
          schema:
            type: string
            default: "1"
        - in: query
          name: years
          required: false
          schema:
            type: integer
            default: 10
        - in: query
          name: to_date
          required: false
          schema:
            type: string
            format: date
        - in: query
          name: from_date
          required: false
          schema:
            type: string
            format: date
        - in: query
          name: user_key
          required: false
          schema:
            type: string
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HistoricalUpstoxResponse"
        "400":
          description: Bad Request
        "401":
          description: Unauthorized
        "404":
          description: Not Found

  /api/indicators:
    post:
      operationId: computeIndicators
      summary: Compute technical indicators
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IndicatorsRequest"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IndicatorsResponse"
        "404":
          description: Not Found

components:
  schemas:
    Candle:
      type: object
      properties:
        t:
          type: string
        o:
          type: number
        h:
          type: number
        l:
          type: number
        c:
          type: number
        v:
          type: number
      required: [t, o, h, l, c, v]

    HistoricalResponse:
      type: object
      properties:
        symbol:
          type: string
        candles:
          type: array
          items:
            $ref: "#/components/schemas/Candle"
      required: [symbol, candles]

    HistoricalUpstoxResponse:
      type: object
      properties:
        instrument_key:
          type: string
        unit:
          type: string
        interval:
          type: string
        from_date:
          type: ["string", "null"]
        to_date:
          type: ["string", "null"]
        count:
          type: integer
        candles:
          type: array
          items:
            $ref: "#/components/schemas/Candle"
      required: [instrument_key, unit, interval, count, candles]

    IndicatorsRequest:
      type: object
      properties:
        symbol:
          type: string
        data_source:
          type: string
          enum: [auto, upstox, yfinance]
          default: auto
        unit:
          type: string
          enum: [days, weeks, months]
          default: days
        interval:
          type: string
          default: "1"
        period:
          type: string
          default: 1y
        hist_date:
          type: ["string", "null"]
          format: date
      required: [symbol]

    IndicatorsResponse:
      type: object
      properties:
        symbol:
          type: string
        as_of:
          type: string
        RSI_14:
          type: ["number", "null"]
        MACD:
          type: object
          properties:
            macd:
              type: ["number", "null"]
            signal:
              type: ["number", "null"]
            hist:
              type: ["number", "null"]
        Bollinger:
          type: object
          properties:
            MA20:
              type: ["number", "null"]
            Upper:
              type: ["number", "null"]
            Lower:
              type: ["number", "null"]
        SMA:
          type: object
          properties:
            SMA_50:
              type: ["number", "null"]
            SMA_100:
              type: ["number", "null"]
            SMA_150:
              type: ["number", "null"]
            SMA_200:
              type: ["number", "null"]
        EMA:
          type: object
          properties:
            EMA_50:
              type: ["number", "null"]
            EMA_100:
              type: ["number", "null"]
            EMA_150:
              type: ["number", "null"]
            EMA_200:
              type: ["number", "null"]
      required: [symbol, as_of]

    MapResponse:
      type: object
      properties:
        symbol:
          type: string
        found:
          type: boolean
        trading_symbol:
          type: ["string", "null"]
        instrument_key:
          type: ["string", "null"]
        segment:
          type: ["string", "null"]
        exchange:
          type: ["string", "null"]
        short_name:
          type: ["string", "null"]
        message:
          type: ["string", "null"]
      required: [symbol, found]
