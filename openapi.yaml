openapi: 3.1.0
info:
  title: Market Bridge API - OHLCV & Indicators Only
  version: 1.2.0
  description: >
    Narrow-scoped API surface for Market Bridge, focused on:
      - Daily OHLCV candles (Upstox + yfinance)
      - Technical indicators (RSI, MACD, Bollinger, SMA/EMA 50/200)
      - Symbol mapping for NSE/BSE normalization

    Design notes for the assistant using this API:
      - Prefer Upstox for history when available; fall back to yfinance automatically.
      - Use only daily candles (1d) for all calculations.
      - For multiple symbols, call the endpoints sequentially, one symbol at a time.
      - Do not ask the user whether to switch between Upstox and yfinance; handle it automatically.
      - Do not call any other external data sources directly from the assistant.
servers:
  - url: https://your-app.onrender.com   # replace with your actual Render URL

paths:
  /health:
    get:
      operationId: healthCheck
      summary: Health check
      description: >
        Lightweight liveness probe. The assistant may optionally call this once
        to verify connectivity.
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  ts:
                    type: number

  /api/map:
    get:
      operationId: mapSymbol
      summary: Normalize symbol to Upstox instrument
      description: >
        Map a stock symbol to an Upstox instrument.

        Usage guidance for the assistant:
          - Use this to normalize user-provided tickers to NSE/BSE-style symbols.
          - Accept symbols like `RELIANCE`, `RELIANCE.NS`, `RELIANCE.BO`.
          - Normalize to the correct trading_symbol and instrument_key.
      parameters:
        - in: query
          name: symbol
          required: true
          schema:
            type: string
          description: User-provided ticker symbol, e.g. RELIANCE, RELIANCE.NS, TCS.NS.
      responses:
        '200':
          description: Mapping result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MapResponse'

  /api/historical:
    get:
      operationId: getHistoricalYfinance
      summary: Historical OHLCV from yfinance (daily candles)
      description: >
        Fetch historical OHLCV candles from yfinance.

        Usage guidance for the assistant:
          - Always request daily candles (interval=1d).
          - Use this as a fallback when Upstox historical data is not available.
          - Compute 1-week and 1-month average volumes from the returned candles
            (based on daily volume data and user-specified dates).
      parameters:
        - in: query
          name: symbol
          required: true
          schema:
            type: string
          description: Ticker symbol understood by yfinance, e.g. RELIANCE.NS.
        - in: query
          name: period
          required: false
          schema:
            type: string
            default: '6mo'
          description: >
            History window, e.g. 1mo, 3mo, 6mo, 1y. Use enough data to compute
            1-week and 1-month average volumes.
        - in: query
          name: interval
          required: false
          schema:
            type: string
            default: '1d'
          description: >
            Candle interval. The assistant should always keep this at '1d'
            (daily candles only).
      responses:
        '200':
          description: Daily OHLCV candles
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoricalResponse'
        '404':
          description: No data found for symbol/period

  /api/historical_upstox:
    get:
      operationId: getHistoricalUpstox
      summary: Historical OHLCV from Upstox (daily candles preferred)
      description: >
        Fetch historical OHLCV candles from Upstox (v3 with v2 fallback).

        Usage guidance for the assistant:
          - Prefer unit=days and interval=1 to obtain daily candles.
          - Use this endpoint as the primary data source when available.
          - If this endpoint returns 404 or empty data, immediately fall back to
            /api/historical for the same symbol (no user confirmation).
          - Use the returned daily candles to compute 1-week and 1-month average
            volumes for the requested dates.
      parameters:
        - in: query
          name: symbol
          required: false
          schema:
            type: string
          description: >
            Ticker symbol, e.g. RELIANCE.NS. Optional if instrument_key is
            provided.
        - in: query
          name: instrument_key
          required: false
          schema:
            type: string
          description: >
            Upstox instrument_key. If provided, takes precedence over symbol.
        - in: query
          name: unit
          required: false
          schema:
            type: string
            default: days
            enum: [days, weeks, months]
          description: >
            Time unit. The assistant should use 'days' for daily candles and
            avoid other units unless strictly necessary.
        - in: query
          name: interval
          required: false
          schema:
            type: string
            default: '1'
          description: >
            Candle interval. Use '1' for daily candles.
        - in: query
          name: years
          required: false
          schema:
            type: integer
            default: 10
          description: >
            Approximate number of years of history to fetch. Use only as much as
            needed for the requested calculations.
        - in: query
          name: to_date
          required: false
          schema:
            type: string
            format: date
          description: >
            End date (YYYY-MM-DD). Optional; defaults to latest.
        - in: query
          name: from_date
          required: false
          schema:
            type: string
            format: date
          description: >
            Start date (YYYY-MM-DD). Optional; derived from `years` if omitted.
        - in: query
          name: user_key
          required: false
          schema:
            type: string
          description: >
            User key for OAuth-based Upstox access (if STATIC_BEARER is not
            configured on the server).
      responses:
        '200':
          description: Daily (or weekly/monthly) OHLCV candles from Upstox
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoricalUpstoxResponse'
        '400':
          description: Missing required parameters
        '401':
          description: Upstox not linked / bearer not configured
        '404':
          description: >
            No data from Upstox (assistant should fall back to /api/historical).

  /api/indicators:
    post:
      operationId: computeIndicators
      summary: Compute technical indicators (RSI, MACD, Bollinger, SMA/EMA 50/200)
      description: >
        Compute technical indicators for a symbol.

        Backend behaviour:
          - The server fetches price history from Upstox or yfinance depending
            on `data_source`.
          - For data_source='auto' the backend tries Upstox first and then
            falls back to yfinance automatically.

        Usage guidance for the assistant:
          - Use only daily data (unit='days', interval='1').
          - Do not ask the user whether to switch between Upstox and yfinance;
            rely on data_source='auto'.
          - Use the following fields in responses:
              - RSI_14
              - MACD.macd (MACD line), MACD.signal, MACD.hist
              - Bollinger.Upper, Bollinger.MA20 (middle), Bollinger.Lower
              - SMA.SMA_50, SMA.SMA_200
              - EMA.EMA_50, EMA.EMA_200
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IndicatorsRequest'
      responses:
        '200':
          description: Indicators result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IndicatorsResponse'
        '404':
          description: No data available to compute indicators

components:
  schemas:
    Candle:
      type: object
      description: Single OHLCV candle.
      properties:
        t:
          type: string
          description: Timestamp (ISO or string form of the index).
        o:
          type: number
          description: Open.
        h:
          type: number
          description: High.
        l:
          type: number
          description: Low.
        c:
          type: number
          description: Close.
        v:
          type: number
          description: Volume.
      required: [t, o, h, l, c, v]

    HistoricalResponse:
      type: object
      description: Historical OHLCV response from /api/historical.
      properties:
        symbol:
          type: string
        candles:
          type: array
          items:
            $ref: '#/components/schemas/Candle'
      required: [symbol, candles]

    HistoricalUpstoxResponse:
      type: object
      description: Historical OHLCV response from /api/historical_upstox.
      properties:
        instrument_key:
          type: string
        unit:
          type: string
        interval:
          type: string
        from_date:
          type: string
          nullable: true
        to_date:
          type: string
          nullable: true
        count:
          type: integer
        candles:
          type: array
          items:
            $ref: '#/components/schemas/Candle'
      required: [instrument_key, unit, interval, count, candles]

    IndicatorsRequest:
      type: object
      properties:
        symbol:
          type: string
          description: >
            Ticker symbol. The assistant should normalize user input to an
            NSE/BSE style, e.g. RELIANCE.NS.
        data_source:
          type: string
          description: >
            Data source selector: 'auto' (Upstoxâ†’yfinance), 'upstox', or
            'yfinance'. For most use-cases, the assistant should use 'auto'.
          default: auto
          enum: [auto, upstox, yfinance]
        unit:
          type: string
          description: >
            Time unit for Upstox requests; use 'days' for daily candles only.
          default: days
          enum: [days, weeks, months]
        interval:
          type: string
          description: >
            Candle interval; use '1' for daily candles only.
          default: '1'
        period:
          type: string
          description: History period for yfinance fallback, e.g. '1y'.
          default: '1y'
        hist_date:
          type: string
          format: date
          nullable: true
          description: >
            As-of date (YYYY-MM-DD). If provided, indicators are computed up to
            this date.
      required: [symbol]

    IndicatorsResponse:
      type: object
      description: Technical indicators computed for a symbol.
      properties:
        symbol:
          type: string
        as_of:
          type: string
          description: Date for which indicators are computed (YYYY-MM-DD).
        RSI_14:
          type: number
          nullable: true
          description: 14-period RSI.
        MACD:
          type: object
          description: MACD(12,26,9) values.
          properties:
            macd:
              type: number
              description: MACD line.
            signal:
              type: number
              description: MACD signal line.
            hist:
              type: number
              description: MACD histogram (macd - signal).
        Bollinger:
          type: object
          description: 20-period Bollinger Bands with 2 standard deviations.
          properties:
            MA20:
              type: number
              nullable: true
              description: Middle band (20-period SMA).
            Upper:
              type: number
              nullable: true
              description: Upper band.
            Lower:
              type: number
              nullable: true
              description: Lower band.
        SMA:
          type: object
          description: >
            Simple moving averages. The assistant should primarily use SMA_50
            and SMA_200.
          properties:
            SMA_50:
              type: number
              nullable: true
            SMA_100:
              type: number
              nullable: true
            SMA_150:
              type: number
              nullable: true
            SMA_200:
              type: number
              nullable: true
        EMA:
          type: object
          description: >
            Exponential moving averages. The assistant should primarily use
            EMA_50 and EMA_200.
          properties:
            EMA_50:
              type: number
              nullable: true
            EMA_100:
              type: number
              nullable: true
            EMA_150:
              type: number
              nullable: true
            EMA_200:
              type: number
              nullable: true
      required: [symbol, as_of]

    MapResponse:
      type: object
      description: Result of mapping a symbol to an Upstox instrument.
      properties:
        symbol:
          type: string
        found:
          type: boolean
        trading_symbol:
          type: string
          nullable: true
        instrument_key:
          type: string
          nullable: true
        segment:
          type: string
          nullable: true
        exchange:
          type: string
          nullable: true
        short_name:
          type: string
          nullable: true
        message:
          type: string
          nullable: true
      required: [symbol, found]
